<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>AI Audio Tour Agent</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/browser@0.85.1/build/stlite.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@stlite/browser@0.85.1/build/stlite.js"></script>
</head>
<body>
    <streamlit-app>
        <app-file name="streamlit_app.py" entrypoint>
import streamlit as st
import asyncio
import json
import time
import requests
from typing import List, Dict, Any

# NetMind API Configuration
class NetMindConfig:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://api.netmind.ai/inference-api/openai/v1"
        self.tts_url = "https://api.netmind.ai/inference-api/openai/v1/audio/speech"
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
    
    def chat_completion(self, messages: List[Dict], model: str = "openai/gpt-oss-20b"):
        """Simple chat completion for content generation"""
        try:
            import json as json_lib
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=self.headers,
                data=json_lib.dumps({
                    "model": model,
                    "messages": messages,
                    "max_tokens": 2000,
                    "temperature": 0.7
                }),
                timeout=60
            )
            if response.status_code == 200:
                result = response.json()
                return result["choices"][0]["message"]["content"]
            else:
                # Return a demo tour content when API fails
                return self._get_demo_content(messages[1]["content"] if len(messages) > 1 else "")
        except Exception as e:
            # Return demo content when request fails
            return self._get_demo_content(messages[1]["content"] if len(messages) > 1 else "")
    
    def _get_demo_content(self, prompt: str) -> str:
        """Return demo tour content when API is unavailable"""
        location = "London"  # Default location
        if "location" in prompt.lower():
            # Try to extract location from prompt
            lines = prompt.split('\n')
            for line in lines:
                if 'for' in line and len(line.split()) > 2:
                    potential_location = line.split('for')[1].split('.')[0].strip()
                    if potential_location:
                        location = potential_location
                        break
        
        return f"""Welcome to {location}! 
 
 **Historical Highlights**
 This magnificent city has stood as a testament to human civilization for centuries. From ancient foundations to modern marvels, every street tells a story of triumph, innovation, and cultural evolution.
 
 **Architectural Wonders**
 As you explore, you'll notice the stunning blend of architectural styles that define this cityscape. Gothic spires reach toward the sky while modern glass structures reflect the ambitions of contemporary design.
 
 **Cultural Treasures**
 The local culture is rich with traditions passed down through generations. Street markets buzz with activity, local artisans display their crafts, and the aroma of traditional cuisine fills the air.
 
 **Culinary Delights**
 No visit would be complete without sampling the local gastronomy. From time-honored recipes to innovative fusion dishes, the culinary scene here offers something for every palate.
 
 **Hidden Gems**
 Beyond the famous landmarks, discover quiet courtyards, charming cafes, and local gathering spots where residents share stories and laughter.
 
 *Note: This is a demo tour generated when the NetMind API is unavailable. For personalized, location-specific content, please ensure proper API connectivity.*
 
 Enjoy your exploration! üåü"""
    
    def generate_audio(self, text: str, voice: str = "alloy") -> bytes:
        """Generate audio using NetMind TTS API"""
        try:
            import json as json_lib
            
            # Map voice styles to NetMind TTS model
            voice_mapping = {
                "alloy": "ResembleAI/Chatterbox",
                "nova": "ResembleAI/Chatterbox", 
                "shimmer": "ResembleAI/Chatterbox"
            }
            
            model = voice_mapping.get(voice, "ResembleAI/Chatterbox")
            
            response = requests.post(
                self.tts_url,
                headers=self.headers,
                data=json_lib.dumps({
                    "model": model,
                    "input": text
                }),
                timeout=120
            )
            
            if response.status_code == 200:
                return response.content
            else:
                st.error(f"TTS API Error: {response.status_code} - {response.text}")
                return None
        except Exception as e:
            st.error(f"TTS generation failed: {str(e)}")
            return None

# Simple Tour Manager for stlite
class SimpleTourManager:
    def __init__(self, netmind_config):
        self.netmind = netmind_config
    
    def generate_tour_content(self, location: str, interests: List[str], duration: int) -> str:
        """Generate tour content using NetMind API"""
        
        # Calculate approximate word count based on duration
        words_per_minute = 150  # Average speaking pace
        target_words = duration * words_per_minute
        
        # Create comprehensive prompt
        interests_str = ", ".join(interests)
        
        prompt = f"""Create an engaging audio tour guide script for {location}.
        
Focus on these interests: {interests_str}
Target length: approximately {target_words} words (for {duration} minutes of audio)
        
Requirements:
- Write in a conversational, engaging tone suitable for audio
- Include fascinating stories, historical facts, and local insights
- Structure with clear sections for each interest area
- Use vivid descriptions that help listeners visualize the locations
- Include practical tips and hidden gems
- Make it feel like a knowledgeable local friend is giving the tour
        
Format the response as a flowing narrative suitable for text-to-speech conversion."""
        
        messages = [
            {"role": "system", "content": "You are an expert tour guide with deep knowledge of world destinations. Create engaging, informative audio tour content."},
            {"role": "user", "content": prompt}
        ]
        
        return self.netmind.chat_completion(messages)

# Set page config
st.set_page_config(
    page_title="AI Audio Tour Agent",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Initialize NetMind configuration
if 'netmind_config' not in st.session_state:
    # Using the provided API key
    api_key = "b3e08a955ca24e9e80ffd7f073c2a010"
    st.session_state.netmind_config = NetMindConfig(api_key)
    st.session_state.tour_manager = SimpleTourManager(st.session_state.netmind_config)

# Main UI
st.title("üéß AI Audio Tour Agent")
st.markdown("""
<div style='background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; border-radius: 10px; margin-bottom: 30px;'>
    <h3 style='color: white; margin: 0;'>Welcome to your personalized audio tour guide!</h3>
    <p style='color: white; margin: 10px 0 0 0;'>Explore any location with an engaging, AI-generated tour tailored to your interests.</p>
</div>
""", unsafe_allow_html=True)

# Create layout
col1, col2 = st.columns([2, 1])

with col1:
    st.markdown("### üìç Where would you like to explore?")
    location = st.text_input(
        "Location", 
        placeholder="Enter a city, landmark, or location...",
        label_visibility="collapsed"
    )
    
    st.markdown("### üéØ What interests you?")
    interests = st.multiselect(
        "Interests",
        options=["History", "Architecture", "Culinary", "Culture"],
        default=["History", "Architecture"],
        help="Select the topics you'd like to learn about",
        label_visibility="collapsed"
    )

with col2:
    st.markdown("### ‚è±Ô∏è Tour Settings")
    duration = st.slider(
        "Tour Duration (minutes)",
        min_value=1,
        max_value=20,
        value=5,
        step=1,
        help="Choose how long you'd like your tour to be"
    )
    
    st.markdown("### üé§ Voice Style")
    voice_style = st.selectbox(
        "Guide's Voice Style",
        options=["Friendly & Casual", "Professional & Detailed", "Enthusiastic & Energetic"],
        help="Select the personality of your tour guide"
    )

# Generate Tour Button
if st.button("üöÄ Generate Tour", type="primary", use_container_width=True):
    if not location:
        st.error("Please enter a location.")
    elif not interests:
        st.error("Please select at least one interest category.")
    else:
        with st.spinner(f"Creating your personalized tour of {location}..."):
            try:
                # Generate tour content
                tour_content = st.session_state.tour_manager.generate_tour_content(
                    location, interests, duration
                )
                
                # Display the tour content
                st.markdown("---")
                st.markdown("## üìñ Your Personalized Tour")
                
                # Create an attractive display for the tour content
                st.markdown(
                    f"""
                    <div style='background: #f8f9fa; padding: 20px; border-radius: 10px; 
                               border-left: 4px solid #667eea; margin: 20px 0;'>
                        <h4 style='color: #333; margin-top: 0;'>üéØ {location} Tour</h4>
                        <p style='color: #666; margin-bottom: 15px;'>
                            <strong>Interests:</strong> {', '.join(interests)} | 
                            <strong>Duration:</strong> {duration} minutes | 
                            <strong>Style:</strong> {voice_style}
                        </p>
                    </div>
                    """,
                    unsafe_allow_html=True
                )
                
                # Display tour content in expandable section
                with st.expander("üìù Tour Content", expanded=True):
                    st.markdown(tour_content)
                
                # Audio generation with NetMind TTS
                st.markdown("### üéµ Generate Audio Tour")
                
                voice_options = {
                    "Friendly & Casual": "alloy",
                    "Professional & Detailed": "nova", 
                    "Enthusiastic & Energetic": "shimmer"
                }
                
                selected_voice = voice_options.get(voice_style, "alloy")
                
                if st.button("üé§ Generate Audio", type="secondary", use_container_width=True):
                    with st.spinner("Generating audio with NetMind TTS..."):
                        try:
                            # Generate audio using NetMind API
                            audio_data = st.session_state.netmind_config.generate_audio(
                                tour_content, selected_voice
                            )
                            
                            if audio_data:
                                st.success("‚úÖ Audio generated successfully!")
                                
                                # Play audio
                                st.audio(audio_data, format='audio/mp3')
                                
                                # Download option
                                st.download_button(
                                    label="üíæ Download Audio",
                                    data=audio_data,
                                    file_name=f"{location.lower().replace(' ', '_')}_tour.mp3",
                                    mime="audio/mp3"
                                )
                            else:
                                st.error("Failed to generate audio. Please try again.")
                                
                        except Exception as e:
                            st.error(f"Audio generation error: {str(e)}")
                            st.info("You can still download the text version below.")
                
                # Download option for the text
                st.download_button(
                    label="üìÑ Download Tour Text",
                    data=tour_content,
                    file_name=f"{location.lower().replace(' ', '_')}_tour.txt",
                    mime="text/plain"
                )
                
                st.success("‚úÖ Tour generated successfully using NetMind AI!")
                
            except Exception as e:
                st.error(f"‚ùå Error generating tour: {str(e)}")
                st.info("Please check your internet connection and try again.")

# Footer with NetMind branding
st.markdown("---")
col1, col2, col3 = st.columns([1, 2, 1])
with col2:
    st.markdown(
        """
        <div style='text-align: center; padding: 20px;'>
            <p style='color: #666; font-size: 14px; margin-bottom: 10px;'>‚ö° Powered by NetMind Inference API</p>
        </div>
        """, 
        unsafe_allow_html=True
    )
    
    # NetMind link button
    if st.button("üöÄ Explore NetMind Model Library", use_container_width=True):
        st.markdown(
            """
            <script>
                window.open('https://www.netmind.ai/modelsLibrary', '_blank');
            </script>
            """,
            unsafe_allow_html=True
        )
        st.success("Opening NetMind Model Library in a new tab...")
        st.markdown("[Click here if the page didn't open automatically](https://www.netmind.ai/modelsLibrary)")

# Add some custom CSS for better styling
st.markdown("""
<style>
    .stButton > button {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .stButton > button:hover {
        background: linear-gradient(90deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .stSelectbox > div > div {
        border-radius: 5px;
    }
    
    .stTextInput > div > div > input {
        border-radius: 5px;
    }
    
    .stMultiSelect > div > div {
        border-radius: 5px;
    }
</style>
""", unsafe_allow_html=True)
        </app-file>
        <app-requirements>
            requests
        </app-requirements>
    </streamlit-app>
</body>
</html>